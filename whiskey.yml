
Build:
- TaskDefaults:
    Pester4:
        .Verbose: false
        Version: 4.*

- Version:
    Path: Whiskey\Whiskey.psd1
    PowerShellModuleName: Whiskey
    Prerelease:
    - main: ""
    - master: ""
    - "release/*": ""
    - "*": rc1
    IncrementPrereleaseVersion: true

# Update the AppVeyor build/version number.
- Exec: appveyor UpdateBuild -Version "$(WHISKEY_SEMVER2)+$(WHISKEY_BUILD_NUMBER)"
  .OnlyBy: BuildServer
  .Debug: true
  .Verbose: true

- PowerShell: prism install | Format-Table -Auto

# Dot-sourcing a lot of files when importing a module varys from expensive to really expensive. Merge them into the module manifest.
- MergeFile:
    .OnlyBy: BuildServer
    Path:
    - Whiskey\Functions\*.ps1
    - Whiskey\Tasks\*.ps1
    DestinationPath:
    - Whiskey\Whiskey.psm1
    TextSeparator: "$(NewLine)$(NewLine)"
    DeleteSourceFiles: true

- CopyFile:
    Path:
    - CHANGELOG.md
    - README.md
    DestinationDirectory: Whiskey

# PublishPowerShellModule should come *before* we create the ZIP file so that the ZIP file contains a module manifest
# that has prerelease metadata in it, if needed (which gets added by PublishPowerShellModule).
- PublishPowerShellModule:
    Path: Whiskey

- Exec: appveyor PushArtifact ".output/Whiskey.$(WHISKEY_SEMVER2_NO_BUILD_METADATA).nupkg" -DeploymentName PowerShellGallery
  .OnlyBy: BuildServer

- Zip:
    ArchivePath: .output\Whiskey-$(WHISKEY_SEMVER2).zip
    Path:
    - Whiskey
    Exclude:
    - "*.pdb"
    - "*.orig"

- Exec: appveyor PushArtifact ".output/Whiskey-$(WHISKEY_SEMVER2).zip" -DeploymentName GitHub
  .OnlyBy: BuildServer

- Exec: appveyor PushArtifact 'Whiskey/build.ps1' -DeploymentName GitHub
  .OnlyBy: BuildServer

- PowerShell: .\Test-Whiskey.ps1 -RunnerCount $env:WHISKEY_CI_NUM_TEST_RUNNERS
